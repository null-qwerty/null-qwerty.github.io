---
title: 五连杆正运动学解算
date: 2025-01-24 00:07:58
excerpt: 轮腿机器人五连杆正运动学解算
tags:
- RoboMaster
- 轮腿
- 控制
mathjax: true
---

![五连杆模型](https://images.null-qwerty.work/blog/五连杆.png)

## 正运动学解算

如图所示五连杆模型，其中 $A$、$E$ 为关节电机；$\psi_1$、$\psi_4$ 为电机输出角度，可由编码器读出；$l_1, l_2, l_3, l_4, l_5$ 为连杆长度。需要求解 $\psi_0$ 和 $l_0$。

以 $AE$ 中点 $M$ 为原点，$AE$ 为 $x$ 轴，垂直 $AE$ 的向上为 $y$ 轴，建立平面直角坐标系。设 $A,B,C,D,E$ 的坐标分别为 $(A_x, A_y), (B_x, B_y), (C_x, C_y), (D_x, D_y), (E_x, E_y)$。

对于 $C$ 点，有：

$$
\begin{cases}
C_x &= B_x + l_2 \cos \psi_2 = D_x + l_3 \cos \psi_3 \newline
C_y &= B_y + l_2 \sin \psi_2 = D_y + l_3 \sin \psi_3 \tag{1}
\end{cases}
$$

对公式 $(1)$ 移项并平方相加，得：

$$
\begin{align}
(B_x - D_x)^2 + (B_y - D_y)^2 + 2l_2(B_x - D_x)\cos \psi_2 + 2l_1(B_y - D_y)\sin \psi_2 &= l_3^2 - l_2^2
\end{align}
$$

令 $l_{BD}^2 = (B_x - D_x)^2 + (B_y - D_y)^2,m = 2l_2(B_x - D_x),n = 2l_2(B_y - D_y)$，则有：

$$
\begin{align}
l_{BD}^2 + m\cos \psi_2 + n\sin \psi_2 &= l_3^2 - l_2^2 
\end{align}
$$

移项，令 $p = l_3^2 - l_2^2 - l_{BD}^2$，则有：

$$
\begin{align}
m\cos \psi_2 + n\sin \psi_2 &= p \tag{2}
\end{align}
$$

由二倍角公式，有：

$$
\begin{align}
\cos \psi_2 &= \cos^2 \frac{\psi_2}{2} - \sin^2 \frac{\psi_2}{2} = \frac{1 - \tan^2 \frac{\psi_2}{2}}{1 + \tan^2 \frac{\psi_2}{2}} \newline
\sin \psi_2 &= 2\sin \frac{\psi_2}{2}\cos \frac{\psi_2}{2} = \frac{2\tan \frac{\psi_2}{2}}{1 + \tan^2 \frac{\psi_2}{2}}
\end{align}
$$

则 $(2)$ 式可化为：

$$
\begin{align}
m\frac{1 - \tan^2 \frac{\psi_2}{2}}{1 + \tan^2 \frac{\psi_2}{2}} + n\frac{2\tan \frac{\psi_2}{2}}{1 + \tan^2 \frac{\psi_2}{2}} &= p
\end{align}
$$

整理得：

$$
\begin{align}
(p + m)\tan^2 \frac{\psi_2}{2} - 2n\tan \frac{\psi_2}{2} + (p - m) &= 0 \tag{3}
\end{align}
$$

$(3)$ 式为关于 $\tan \frac{\psi_2}{2}$ 的一元二次方程，其判别式：

$$
\begin{align}
\Delta &= 4n^2 - 4(p + m)(p - m) = 4(m^2 + n^2 - p^2)
\end{align}
$$

其解为：

$$
\begin{align}
\tan \frac{\psi_2}{2} &= \frac{n \pm \sqrt{m^2 + n^2 - p^2}}{p + m}
\end{align}
$$

则有：

$$
\begin{align}
\psi_2 &= 2\arctan \frac{n \pm \sqrt{m^2 + n^2 - p^2}}{p + m}
\end{align}
$$

考虑机械结构及限位，$l_{BD} < l_2 + l_3$，当 $l_2 = l_3$ 时，判别式 $\Delta > 0$ 恒成立：

$$
\begin{align}
\Delta &= 4(m^2 + n^2 - p^2) = 4(4l_2^2l_{BD}^2 - l_{BD}^4) = 4l_{BD}^2(4l_2^2 - l_{BD}^2) > 0
\end{align}
$$

易知 $(3)$ 式的解其实就是 $\psi_2$ 和 $\psi_3$。根据图中关系有：

$$
\begin{align}
0 < \psi_2 < \frac{\pi}{2} < \psi_3 < \pi
\end{align}
$$

因此取正根：

$$
\begin{align}
\psi_2 &= 2\arctan \frac{n + \sqrt{m^2 + n^2 - p^2}}{p + m}
\end{align}
$$

由此可求出 $C$ 点坐标 $(C_x, C_y)$：

$$
\begin{cases}
C_x &= -\frac{l_5}{2} + l_1\cos \psi_1 + l2\cos \psi_2 \newline 
C_y &= l_1\sin \psi_1 + l_2\sin \psi_2 \tag{4}
\end{cases}
$$

化为极坐标系，解出 $\psi_0$ 和 $l_0$：

$$
\begin{cases}
\psi_0 &= \arctan \frac{C_y}{C_x} \newline
l_0 &= \sqrt{C_x^2 + C_y^2}
\end{cases}
$$

至此，五连杆正运动学解算完毕。

## 计算力矩转换的雅可比矩阵

上面由正运动学解算将五连杆机构构造成了一个虚拟的倒立摆模型。虽然可以简化我们的控制算法，但在实际控制中，仍然需要将电机的力矩转换为虚拟倒立摆的力矩。我们可以通过雅可比矩阵来实现这个转换。

> 本部分参考[玺佬的文章](https://zhuanlan.zhihu.com/p/613007726)，这里只贴 matlab 代码，具体推导过程请参考原文。

```matlab
syms x_A x_E y_A y_E phi_1(t) phi_2(t) phi_3(t) phi_4(t) phi_dot_1 phi_dot_4 l_1 l_2 l_3 l_4 l_5

% 位置关系
x_A = -l_5/2;
x_E = l_5/2;
y_A = 0;
y_E = 0;

x_B = x_A + l_1*cos(phi_1);
y_B = y_A + l_1*sin(phi_1);
x_D = x_E + l_4*cos(phi_4);
y_D = y_E + l_4*sin(phi_4);

x_C = x_B + l_2*cos(phi_2);
y_C = y_B + l_2*sin(phi_2);
% 速度关系
x_dot_B = diff(x_B,t);
y_dot_B = diff(y_B,t);
x_dot_D = diff(x_D,t);
y_dot_D = diff(y_D,t);

x_dot_C = diff(x_C,t);
y_dot_C = diff(y_C,t);

phi_dot_2 = ((x_dot_D-x_dot_B)*cos(phi_3)+(y_dot_D-y_dot_B)*sin(phi_3))/l_2/sin(phi_3-phi_2);
% 代数
x_dot_C = subs(x_dot_C,diff(phi_2,t),phi_dot_2);
x_dot_C = subs(x_dot_C,[diff(phi_1,t),diff(phi_4,t)],[phi_dot_1,phi_dot_4]);
y_dot_C = subs(y_dot_C,diff(phi_2,t),phi_dot_2);
y_dot_C = subs(y_dot_C,[diff(phi_2,t),diff(phi_1,t),diff(phi_4,t)],[phi_dot_2,phi_dot_1,phi_dot_4]);
% 计算雅可比矩阵
x_dot = [x_dot_C;y_dot_C];
q_dot = [phi_dot_1;phi_dot_4];
x_dot = simplify(collect(x_dot,q_dot));
J=simplify(jacobian(x_dot,q_dot))
% 转极坐标
syms phi_0 l_0

R = [cos(phi_0-pi/2) -sin(phi_0-pi/2);
     sin(phi_0-pi/2)  cos(phi_0-pi/2)];
M = [0 -1/l_0;
     1     0];
T = simplify(J.'*R*M)
```

最后得出的结果与原文一致：

$$
\begin{align}
T(t) &= \begin{bmatrix}
\frac{l_1\sin(\phi_0-\phi_3)\sin(\phi_1-\phi_2)}{\sin(\phi_3-\phi_2)} & \frac{l_1\cos(\phi_0-\phi_3)\sin(\phi_1-\phi_2)}{l_0\sin(\phi_3-\phi_2)} \newline
\frac{l_4\sin(\phi_0-\phi_2)\sin(\phi_3-\phi_4)}{\sin(\phi_3-\phi_2)} & \frac{l_4\cos(\phi_0-\phi_2)\sin(\phi_3-\phi_4)}{l_0\sin(\phi_3-\phi_2)}
\end{bmatrix}
\end{align}
$$